---
title: "Swap Performance"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
params:
  pair: "KSM:KUSD"
  xdays: 14
  madays: 7
  
---

```{css custom2, echo=FALSE}
.dataTables_scrollBody {
    max-height: 100% !important;
}
```

```{r init, include=FALSE}

library(rmarkdown)
library(flexdashboard)
library(dygraphs)


xdays <- params$xdays
madays <- params$madays
pair <- params$pair

if (pair == "ALL") {
  resx <- swaps[date >= max(swaps$date) - xdays]
    tvl <- swaps2[, sum(tvlUSD), by = date] %>%
      setnames(c("date","V1"), c("Date","tvlUSD"))
} else {
  resx <- swaps[pair1==params$pair | pair2==params$pair | pair3==params$pair & date >= max(swaps$date) - xdays]
    tvl <- swaps2[pair == params$pair, tvlUSD, by = date] %>% 
      setnames("date","Date")
}

# Helper function to concat
`%+%` <- function(a, b) paste0(a, b)

# helper function to color the bars in the charts (green, red)
getColor <- function(status) ifelse(status >= 1, "green", "red")

```

# Pairs {.tabset}
Row
----

### Daily Active Users

```{r}

  activeUsers <- resx[!duplicated(accountId), .N, by = date] %>%
    setnames(c("Date","Active Users"))

  u_list <<- activeUsers$`Active Users`
  activeUsers[, Average := frollmean(`Active Users`, madays)]  
  
  activeUsersAvg <- tail(activeUsers$Average, 1)
  activeUsersStatus <<- round(tail(activeUsers$`Active Users`, 1) / activeUsersAvg, 2)

  if (activeUsersStatus < 1) {
    txt <- " down " %+% as.character((activeUsersStatus-1)*100) %+% "% vs. " %+% madays %+% "D Avg"
    txt <- g(tail(activeUsers$`Active Users`, 1), 1) %+% "_" %+% g(activeUsersAvg,1) 
  } else {
    txt <- " up " %+% as.character((activeUsersStatus-1)*100) %+% "% vs. " %+% madays %+% "D Avg"
    txt <- g(tail(activeUsers$`Active Users`, 1), 1) %+% "_" %+% g(activeUsersAvg,1) 
  }

  add1 <- tail(activeUsers, 1)
  add1[, Date := Date + 1]
  activeUsers <- rbind(activeUsers, add1)
  
  dygraph(activeUsers, main = "Active Users" %+% txt)  %>%
    dySeries("Active Users", stepPlot = TRUE, fill = TRUE, color = getColor(activeUsersStatus)) %>%
    dySeries("Average", color = "blue")
  

```

### Daily Trades

```{r}

  trades <- resx[, .N, by = date] %>%
    setnames(c("Date","Trades"))

  t_list <<- trades$Trades
  trades[, Average := frollmean(`Trades`, madays)]  
  
  tradesAvg <- tail(trades$Average, 1)
  tradesStatus <<- round(tail(trades$Trades, 1) / tradesAvg, 2)

  if (tradesStatus < 1) {
    txt <- " down " %+% as.character((tradesStatus-1)*100) %+% "% vs. " %+% madays %+% "D Avg"
  } else {
    txt <- " up " %+% as.character((tradesStatus-1)*100) %+% "% vs. " %+% madays %+% "D Avg"
  }

  add1 <- tail(trades, 1)
  add1[, Date := Date + 1]
  trades <- rbind(trades, add1)
  
  dygraph(trades, main = "Trades" %+% txt)  %>% 
    dySeries("Trades", stepPlot = TRUE, fill = TRUE, color = getColor(tradesStatus)) %>%
    dySeries("Average", color = "blue") 

```

Row 
----

### Daily Trades Per User

```{r}

  activeUsers <- resx[!duplicated(accountId), .N, by = date] %>%
    setnames(c("Date","Active Users"))
  
  trades <- resx[, .N, by = date] %>%
    setnames(c("Date","Trades"))

  avgTrade <- merge(trades, activeUsers, by = 'Date')
  avgTrade[, `Trades per user` := round(Trades / `Active Users`, 1)]
  
  p_list <<- avgTrade$`Trades per user`
  avgTrade[, `Average` := frollmean(`Trades per user`, madays)]  
  
  avgTradeAvg <- tail(avgTrade$Average, 1)
  avgTradeStatus <<- round(tail(avgTrade$`Trades per user`, 1) / avgTradeAvg, 2)
  if (avgTradeStatus < 1) {
    txt <- " down " %+% as.character((avgTradeStatus-1)*100) %+% "% vs. " %+% madays %+% "D Avg"
  } else {
    txt <- " up " %+% as.character((avgTradeStatus-1)*100) %+% "% vs. " %+% madays %+% "D Avg"
  }

  avgTrade[, Trades := NULL]
  avgTrade[, `Active Users` := NULL]

  add1 <- tail(avgTrade, 1)
  add1[, Date := Date + 1]
  avgTrade <- rbind(avgTrade, add1)
  
  dygraph(avgTrade, main = "Trades Per User" %+% txt)  %>% 
    dySeries("Trades per user", stepPlot = TRUE, fill = TRUE, color = getColor(avgTradeStatus)) %>%
    dySeries("Average", color = "blue") 

```

### Daily Fees in USD

```{r}

  fees <- resx[, sum(fee), by = date] %>%
    setnames(c("Date","Swap Fees"))

  # u_list <<- activeUsers$`Active Users`
  fees[, `Average` := frollmean(`Swap Fees`, madays)]  
  
  feesAvg <- tail(fees$Average, 1)
  feesStatus <<- round(tail(fees$`Swap Fees`, 1) / feesAvg, 2)

  if (feesStatus < 1) {
    txt <- " down " %+% as.character((feesStatus-1)*100) %+% "% vs. " %+% madays %+% "D Avg"
  } else {
    txt <- " up " %+% as.character((feesStatus-1)*100) %+% "% vs. " %+% madays %+% "D Avg"
  }
  
  add1 <- tail(fees, 1)
  add1[, Date := Date + 1]
  fees <- rbind(fees, add1)
  
  dygraph(fees, main = "Swap Fees" %+% txt)  %>% 
    dySeries("Swap Fees", stepPlot = TRUE, fill = TRUE, color = getColor(feesStatus)) %>%
    dySeries("Average", color = "blue") 

```

Row
---

### Daily Trading Volume

```{r}

  tradeVolume <- resx[, sum(volumeUSDFloat), by = date] %>%
    setnames(c("Date","Trading Volume"))
  
  v_list <<- tradeVolume$`Trading Volume`
  tradeVolume[, `Average` := frollmean(`Trading Volume`, madays)]  
  
  tradeVolumeAvg <- tail(tradeVolume$Average, 1)
  tradeVolumeStatus <<- round(tail(tradeVolume$`Trading Volume`, 1) / tradeVolumeAvg, 2)

  if (tradeVolumeStatus < 1) {
    txt <- " down " %+% as.character((tradeVolumeStatus-1)*100) %+% "% vs. " %+% madays %+% "D Avg"
  } else {
    txt <- " up " %+% as.character((tradeVolumeStatus-1)*100) %+% "% vs. " %+% madays %+% "D Avg"
  }

  add1 <- tail(tradeVolume, 1)
  add1[, Date := Date + 1]
  tradeVolume <- rbind(tradeVolume, add1)
  
  dygraph(tradeVolume, main = "Trading Volume" %+% txt)  %>% 
    dySeries("Trading Volume", stepPlot = TRUE, fill = TRUE, color = getColor(tradeVolumeStatus)) %>%
    dySeries("Average", color = "blue") 

```


### Daily Volume / Total Value Locked Ratio

```{r}


  tradeVolume <- resx[, sum(volumeUSDFloat), by = date] %>%
    setnames(c("Date","Trading Volume"))
  tvl <- merge(tradeVolume, tvl, by ="Date")
  tvl[, "Volume To TVL" := `Trading Volume` / tvlUSD]
   
  tvl[, `Average` := frollmean(`Volume To TVL`, madays)]  
  
  volumeToTVLAvg <- tail(tvl$Average, 1)
  volumeToTVLStatus <<- round(tail(tvl$`Average`, 1) / volumeToTVLAvg, 2)

  if (volumeToTVLStatus < 1) {
    txt <- " down " %+% as.character((volumeToTVLStatus-1)*100) %+% "% vs. " %+% madays %+% "D Avg"
  } else {
    txt <- " up " %+% as.character((volumeToTVLStatus-1)*100) %+% "% vs. " %+% madays %+% "D Avg"
  }

  tvl[, `Trading Volume` := NULL]
  tvl[, `tvlUSD` := NULL]
  
  # add1 <- tail(tvl, 1)
  # add1[, Date := Date + 1]
  # tvl <- rbind(tvl, add1)
  
  tvl[, Average := NULL]
  
  dygraph(tvl, main = "Volume To TVL" %+% txt)  %>% 
    dySeries("Volume To TVL", color = getColor(volumeToTVLStatus)) 
  # %>%
  #   dySeries("Average", color = "blue") 

```
