---
title: "Karura Swap Performance"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
params:
  pair: "ALL"
  xdays: 14
---

```{css custom2, echo=FALSE}
.dataTables_scrollBody {
    max-height: 100% !important;
}



```

```{r init, include=FALSE}

library(rmarkdown)
library(flexdashboard)
library(DT)
library(dygraphs)


# spacer for numbers above bar on barplot
pad <- .9

xdays <- params$xdays

if (params$pair == "ALL") {
  resx <- res[date >= max(res$date) - xdays]
} else {
  resx <- res[pair == params$pair & date >= max(res$date) - xdays]
}

# Helper function to concat
`%+%` <- function(a, b) paste0(a, b)

# Helper function to download data
create_dt <- function(x){
  DT::datatable(x,
                extensions = 'Buttons',
                options = list(dom = 'Blfrtip',
                               buttons = c('copy', 'csv', 'excel'),
                               lengthMenu = list(c(10, 50, -1),
                                                 c(10, 50, "All"))))
}

# helper function to color the bars in the charts (green, yellow, & red)
getColor <- function(status) {
  ifelse(status >= 1, "#34FF33", ifelse(status >= .5, "#FFC300", "#FF5733"))
}

barChartPlotter <<- "function barChartPlotter(e) {
                var ctx = e.drawingContext;
                var points = e.points;
                var y_bottom = e.dygraph.toDomYCoord(0);  // see     http://dygraphs.com/jsdoc/symbols/Dygraph.html#toDomYCoord

                // This should really be based on the minimum gap
                var bar_width = 2/3 * (points[1].canvasx - points[0].canvasx);
                ctx.fillStyle = e.color;

                // Do the actual plotting.
                for (var i = 0; i < points.length; i++) {
                  var p = points[i];
                  var center_x = p.canvasx;  // center of the bar

                  ctx.fillRect(center_x - bar_width / 2, p.canvasy,
                               bar_width, y_bottom - p.canvasy);
                  ctx.strokeRect(center_x - bar_width / 2, p.canvasy,
                                 bar_width, y_bottom - p.canvasy);
                }
}"

```


# Pairs {.tabset}
Row
----

### Daily Active Users

```{r}

  activeUsers <- resx[!duplicated(accountId), .N, by = date] %>%
    setnames(c("Date","Active Users"))

  u_list <<- activeUsers$`Active Users`
  
  activeUsersAvg <- mean(head(activeUsers$`Active Users`, nrow(activeUsers) - 1))
  activeUsersStatus <<- round(tail(activeUsers$`Active Users`, 1) / activeUsersAvg, 1)

  if (activeUsersStatus < 1) {
    txt <- " down " %+% as.character((activeUsersStatus-1)*100) %+% "% vs. " %+% xdays %+% "D Avg"
  } else {
    txt <- " up " %+% as.character((activeUsersStatus-1)*100) %+% "% vs. " %+% xdays %+% "D Avg"
  }
  
dygraph(activeUsers, main = "Active Users" %+% txt)  %>% 
  dyRoller(rollPeriod = 7) %>%
  dyOptions(useDataTimezone = TRUE, plotter = barChartPlotter)

```

### Daily Trades

```{r}

  trades <- resx[, .N, by = date] %>%
    setnames(c("Date","Trades"))

  t_list <<- trades$`Trades`
  
  tradesAvg <- mean(head(trades$`Trades`, nrow(trades) - 1))
  tradesStatus <<- round(tail(trades$`Trades`, 1) / tradesAvg, 1)

  if (tradesStatus < 1) {
    txt <- " down " %+% as.character((tradesStatus-1)*100) %+% "% vs. " %+% xdays %+% "D Avg"
  } else {
    txt <- " up " %+% as.character((tradesStatus-1)*100) %+% "% vs. " %+% xdays %+% "D Avg"
  }

  dygraph(trades, main = "Trades" %+% txt)  %>% 
    dyRoller(rollPeriod = 7) %>%
    dyOptions(useDataTimezone = TRUE, plotter = barChartPlotter)

```

Row 
----

### Daily Trades Per User

```{r}

  activeUsers <- resx[!duplicated(accountId), .N, by = date] %>%
    setnames(c("Date","Active Users"))
  
  trades <- resx[, .N, by = date] %>%
    setnames(c("Date","Trades"))

  avgTrade <- merge(trades, activeUsers, by = 'Date')
  avgTrade[, `Trades per user` := round(Trades / `Active Users`, 1)]
  
  p_list <<- avgTrade$`Trades per user`
  
  avgTradeAvg <- mean(head(avgTrade$`Trades per user`, nrow(trades) - 1))
  avgTradeStatus <<- round(tail(avgTrade$`Trades per user`, 1) / avgTradeAvg, 1)

  if (avgTradeStatus < 1) {
    txt <- " down " %+% as.character((avgTradeStatus-1)*100) %+% "% vs. " %+% xdays %+% "D Avg"
  } else {
    txt <- " up " %+% as.character((avgTradeStatus-1)*100) %+% "% vs. " %+% xdays %+% "D Avg"
  }

  dygraph(avgTrade, main = "Trades Per User" %+% txt)  %>% 
    dyRoller(rollPeriod = 7) %>%
    dyOptions(useDataTimezone = TRUE, plotter = barChartPlotter)

```

### Daily Trading Volume

```{r}

  tradeVolume <- resx[, sum(as.numeric(volumeUSD) / 1e12 / 1e6), by = date] %>%
    setnames(c("Date","Trading Volume"))
  
  v_list <<- tradeVolume$`Trading Volume`
  
  tradeVolumeAvg <- mean(head(tradeVolume$`Trading Volume`, nrow(tradeVolume) - 1))
  tradeVolumeStatus <<- round(tail(tradeVolume$`Trading Volume`, 1) / tradeVolumeAvg, 1)

  if (tradeVolumeStatus < 1) {
    txt <- " down " %+% as.character((tradeVolumeStatus-1)*100) %+% "% vs. " %+% xdays %+% "D Avg"
  } else {
    txt <- " up " %+% as.character((tradeVolumeStatus-1)*100) %+% "% vs. " %+% xdays %+% "D Avg"
  }

  dygraph(tradeVolume, main = "Trading Volume" %+% txt)  %>% 
    dyRoller(rollPeriod = 7) %>%
    dyOptions(useDataTimezone = TRUE, plotter = barChartPlotter)

```

# Data 

```{r}
create_dt(resx)
```
